
sp {add-procedural-subgoal*propose*create-goal-node
   (state <s> ^name add-procedural-subgoal
              ^subtask-handle <sub-handle>
              ^current-goal-id <next-id>
              ^goal-graph-nodes.goal <prev-id>
             -^subtask-goal-node)
   (<prev-id> ^next <prev-next>)
   (<prev-next> ^goal {@ <next-id>})
-->
   (<s> ^operator <o> + =)
   (<o> ^name create-goal-node
        ^subtask-handle <sub-handle>
        ^next-goal-id <next-id>
        ^prev-goal-id <prev-id>
        ^prev-next-id <prev-next>)
}

sp {add-procedural-subgoal*apply*create-goal-node
   (state <s> ^name add-procedural-subgoal
              ^operator <o>
              ^task-operator.task-handle <task-h>)
   (<o> ^name create-goal-node
        ^subtask-handle <sub-handle>
        ^next-goal-id {@ <next-goal-id>}
        ^prev-goal-id <prev-goal-id>
        ^prev-next-id <prev-next>)
   (<prev-next> ^goal <next-goal-id>)
-->
   (<s> ^subtask-goal-node <node>)
   (<node> ^item-type task-goal
           ^handle (make-constant-symbol <task-h> |goal|)
           ^pred-count 1
           ^1 <pred1>
           ^next <next>)
   (<pred1> ^type subtask
            ^subtask-handle <sub-handle>)
   # Next pointer to the current goal
   (<next> ^goal <next-goal-id>)

   # Make the previous goal point to this one instead
   (<prev-next> ^goal <next-goal-id> -
                ^goal <node>)

   (<s> ^to-store <node> <pred1> <next> <prev-next>)
   (<s> ^change-goal-handle <prev-goal-id>)
}
